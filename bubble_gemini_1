<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤¢å¹»æ³¡æ³¡å¯¦é©—å®¤</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e, #16213e); /* æ·±è‰²èƒŒæ™¯æ›´èƒ½å‡¸é¡¯æ³¡æ³¡ */
            font-family: 'Noto Sans TC', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            cursor: crosshair;
        }

        /* UI å±¤ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° Canvas */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* å•Ÿå‹•ç•«é¢æ–‡å­— (Start æ³¡æ³¡æ˜¯ç•«åœ¨ Canvas ä¸Šçš„ï¼Œé€™è£¡æ˜¯è¼”åŠ©æç¤º) */
        #start-hint {
            position: absolute;
            top: 20%;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.2rem;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        /* å·¥å…·é¸æ“‡æ¬„ (é ‚éƒ¨) */
        .toolbar {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            pointer-events: auto;
            opacity: 0;
            transform: translateY(-50px);
            transition: all 0.5s ease-out;
        }

        .tool-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background: rgba(100, 200, 255, 0.4);
            border-color: rgba(100, 200, 255, 0.8);
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.4);
        }

        /* æ§åˆ¶è‰™ (å³ä¸‹è§’) */
        .cockpit {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 280px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            color: white;
            pointer-events: auto;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.5s ease-out;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .cockpit h3 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #aaddff;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #ddd;
        }

        /* è‡ªå®šç¾©æ»‘æ¡¿æ¨£å¼ */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 5px rgba(255,255,255,0.8);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        /* éŠæˆ²ç‹€æ…‹ Class */
        .game-active .toolbar {
            opacity: 1;
            transform: translateY(0);
        }
        
        .game-active .cockpit {
            opacity: 1;
            transform: translateX(0);
        }
        
        .game-active #start-hint {
            opacity: 0;
        }

        .instruction {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 10px;
            text-align: center;
        }

        /* æ‰‹æ©Ÿæ¿æç¤º */
        @media (max-width: 600px) {
            .cockpit {
                width: calc(100% - 40px);
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
            .toolbar {
                flex-wrap: wrap;
                gap: 5px;
            }
            .tool-btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <canvas id="bubbleCanvas"></canvas>
    </div>

    <div id="ui-layer">
        <div id="start-hint">
            <!-- æç¤ºæ–‡å­—æœƒåœ¨ Start æ³¡æ³¡è¢«æ‰“ç ´å¾Œæ¶ˆå¤± -->
            æˆ³ç ´æ³¡æ³¡é–‹å§‹å¹æ°£ä¹‹æ—…
        </div>

        <div class="toolbar" id="toolbar">
            <button class="tool-btn" onclick="selectTool(0)">ğŸ”« æ³¡æ³¡æ©Ÿ</button>
            <button class="tool-btn" onclick="selectTool(1)">âœ‹ æ‰‹æ‰‹</button>
            <button class="tool-btn" onclick="selectTool(2)">ğŸ§² Må‹å¤¾</button>
        </div>

        <div class="cockpit" id="cockpit">
            <h3>ç’°å¢ƒæ§åˆ¶è‰™</h3>
            
            <div class="control-group">
                <label>é¢¨é€Ÿ (Wind) <span id="val-wind">0</span></label>
                <input type="range" min="-10" max="10" value="2" step="0.5" id="range-wind">
            </div>

            <div class="control-group">
                <label>æŠ˜å°„è§’åº¦ (Light) <span id="val-light">45Â°</span></label>
                <input type="range" min="0" max="360" value="45" id="range-light">
            </div>

            <div class="control-group">
                <label>æ³¡æ³¡éŸŒæ€§ (Life) <span id="val-life">ä¸­</span></label>
                <input type="range" min="50" max="500" value="200" id="range-life">
            </div>

            <div class="instruction">
                æŒ‰ä½æ»‘é¼  / éµç›¤ç©ºç™½éµ / é•·æŒ‰è¢å¹•<br>é–‹å§‹å¹æ³¡æ³¡
            </div>
        </div>
    </div>

    <script>
        /**
         * å¤¢å¹»æ³¡æ³¡å¯¦é©—å®¤ Core Logic
         */
        const canvas = document.getElementById('bubbleCanvas');
        const ctx = canvas.getContext('2d');
        
        // ç‹€æ…‹ç®¡ç†
        const STATE = {
            START_SCREEN: 0,
            PLAYING: 1
        };
        let currentState = STATE.START_SCREEN;

        // å·¥å…·å®šç¾©
        const TOOLS = {
            GUN: 0,   // é›™æ§: å¿«é€Ÿ, å°
            HAND: 1,  // æ‰‹æ‰‹: æ…¢é€Ÿ, æˆé•·å‹
            WAND: 2   // Må‹å¤¾: æ‹–æ›³æ‹‰é•·å‹
        };
        let currentTool = TOOLS.GUN;

        // ç’°å¢ƒè®Šæ•¸
        let env = {
            wind: 2,
            lightAngle: 45, // 0-360
            bubbleLife: 200,
            gravity: -0.05 // è¼•å¾®å‘ä¸Šæµ®åŠ›
        };

        // äº’å‹•ç‹€æ…‹
        let pointer = { x: 0, y: 0, isDown: false, downStart: 0 };
        let width, height;

        // å¯¦é«”å®¹å™¨
        let bubbles = [];
        let particles = []; // ç ´è£‚æ°´ç 
        let startBubble = null; // å•Ÿå‹•æŒ‰éˆ•æ³¡æ³¡

        // éŸ³æ•ˆåˆæˆ (å¯é¸ï¼Œé€™è£¡ä¿æŒéœéŸ³ä»¥ç¬¦åˆç´”è¦–è¦ºè¦æ±‚ï¼Œä½†é ç•™çµæ§‹)
        
        /* --- é¡åˆ¥å®šç¾© --- */

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 5;
                this.vy = (Math.random() - 0.5) * 5;
                this.life = 1.0;
                this.decay = Math.random() * 0.03 + 0.02;
                this.color = color;
                this.size = Math.random() * 2 + 1;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.2; // é‡åŠ›
                this.life -= this.decay;
            }

            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        class Bubble {
            constructor(x, y, radius, vx, vy) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.originalRadius = radius;
                
                // ç‰©ç†å±¬æ€§
                this.vx = vx;
                this.vy = vy;
                
                // å£½å‘½å±¬æ€§
                this.maxLife = env.bubbleLife + Math.random() * 100;
                this.age = 0;
                this.popping = false;
                
                // å½ˆæ€§æ¨¡æ“¬ (Elasticity)
                this.wobblePhase = Math.random() * Math.PI * 2;
                this.wobbleSpeed = 0.1 + Math.random() * 0.1;
                this.wobbleAmp = 0.2; // åˆå§‹æŠ–å‹•å¹…åº¦ (20% åŠå¾‘)
                
                // é¡è‰²èˆ‡å¤–è§€
                this.hueOffset = Math.random() * 360;
            }

            update() {
                this.age++;

                // ç‰©ç†é‹å‹•
                this.x += this.vx;
                this.y += this.vy;

                // ç’°å¢ƒå½±éŸ¿
                this.vx += (env.wind * 0.01); // é¢¨åŠ›
                this.vx *= 0.99; // ç©ºæ°£é˜»åŠ›
                this.vy += env.gravity; // æµ®åŠ›
                this.vy *= 0.99;

                // æ“¾å‹• (å¸ƒæœ—é‹å‹•)
                this.x += Math.sin(this.age * 0.05) * 0.5;

                // å½ˆæ€§è¡°æ¸› (æ…¢æ…¢è®Šåœ“)
                this.wobbleAmp *= 0.98;

                // é‚Šç•Œæª¢æŸ¥ (ç¢°åˆ°åœ°æ¿æˆ–å¤©èŠ±æ¿åå½ˆ)
                if (this.x < -this.radius * 2 || this.x > width + this.radius * 2 || this.y < -100) {
                    this.popping = true; // å‡ºç•Œå°±ç ´æ‰
                }
            }

            draw(ctx) {
                if (this.popping) return;

                // è¨ˆç®—æŠ–å‹•å¾Œçš„å½¢ç‹€
                const wobble = Math.sin(this.age * this.wobbleSpeed + this.wobblePhase) * this.wobbleAmp;
                const rx = this.radius * (1 + wobble);
                const ry = this.radius * (1 - wobble);
                
                // æ—‹è½‰æ³¡æ³¡ (æ¨¡æ“¬æ»¾å‹•)
                const rotation = this.vx * 0.1;

                // è¨ˆç®—é€æ˜åº¦ (ç”Ÿå‘½é€±æœŸï¼šç”Ÿæˆ->ç©©å®š->è®Šç°->ç ´è£‚)
                let alpha = 1;
                let grayness = 0; // 0 = å½©è‰², 1 = ç°è‰²

                const lifePercent = this.age / this.maxLife;
                
                if (lifePercent > 0.8) {
                    // å¿«æ­»çš„æ™‚å€™è®Šé€æ˜ä¸”è®Šç°
                    alpha = 1 - ((lifePercent - 0.8) * 5); 
                    grayness = (lifePercent - 0.8) * 5;
                }
                
                if (lifePercent >= 1) {
                    this.pop();
                    return;
                }

                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(rotation);

                // ç¹ªè£½æ³¡æ³¡æœ¬é«”
                ctx.beginPath();
                ctx.ellipse(0, 0, Math.abs(rx), Math.abs(ry), 0, 0, Math.PI * 2);

                // 1. å¡«å…… - æ¨¡æ“¬è–„è†œå¹²æ¶‰ (Iridescence)
                // æ ¹æ“šå…‰ç·šè§’åº¦å’Œæ™‚é–“æ—‹è½‰è‰²ç›¸
                const lightHue = (env.lightAngle + this.age + this.hueOffset) % 360;
                
                // æ ¸å¿ƒé€æ˜ï¼Œé‚Šç·£æœ‰è‰²å½©
                const gradient = ctx.createRadialGradient(
                    -rx * 0.3, -ry * 0.3, rx * 0.1, // å…‰æºé«˜å…‰é»
                    0, 0, rx
                );

                const saturation = 100 * (1 - grayness);
                const lightness = 50 + (grayness * 20); // è®Šç°æ™‚è®Šäº®ä¸€é»åƒæ­»çš®

                gradient.addColorStop(0, `hsla(0, 0%, 100%, 0)`); // ä¸­å¿ƒå…¨é€
                gradient.addColorStop(0.8, `hsla(${lightHue}, ${saturation}%, ${lightness}%, ${0.1 * alpha})`);
                gradient.addColorStop(1, `hsla(${lightHue + 40}, ${saturation}%, ${lightness}%, ${0.3 * alpha})`);

                ctx.fillStyle = gradient;
                ctx.fill();

                // 2. é‚Šæ¡† - æ²¹è†œæ„Ÿ
                ctx.lineWidth = 1.5;
                ctx.strokeStyle = `hsla(${lightHue}, ${saturation}%, 80%, ${0.4 * alpha})`;
                ctx.stroke();

                // 3. é«˜å…‰ (Reflection) - æ¨¡æ“¬çª—æˆ¶æˆ–å¤ªé™½åå…‰
                ctx.beginPath();
                // åœ¨å·¦ä¸Šè§’ç•«ä¸€å€‹å½æœˆå½¢é«˜å…‰
                ctx.ellipse(-rx * 0.4, -ry * 0.4, rx * 0.15, ry * 0.08, Math.PI / 4, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${0.6 * alpha})`;
                ctx.fill();

                // 4. æ­»å‰çš„æ–‘é» (å¦‚æœå¿«ç ´äº†)
                if (grayness > 0.3) {
                    ctx.fillStyle = `rgba(200, 200, 200, ${0.4 * alpha})`;
                    for(let i=0; i<3; i++) {
                        ctx.beginPath();
                        ctx.arc(rx * 0.5, ry * 0.2 * i, 2, 0, Math.PI*2);
                        ctx.fill();
                    }
                }

                ctx.restore();
            }

            pop() {
                this.popping = true;
                // ç”¢ç”Ÿæ°´ç ç²’å­
                const particleCount = 6 + Math.floor(this.radius / 5);
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle(this.x, this.y, 'rgba(200, 230, 255, 0.8)'));
                }
            }
        }

        class StartBubble extends Bubble {
            constructor(x, y) {
                super(x, y, 80, 0, 0);
                this.maxLife = Infinity; // ä¸æœƒè‡ªç„¶æ­»äº¡
            }

            draw(ctx) {
                if (this.popping) return;
                super.draw(ctx);

                // ç¹ªè£½ START æ–‡å­—
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.fillStyle = "white";
                ctx.font = "bold 30px 'Noto Sans TC'";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 5;
                ctx.fillText("START", 0, 0);
                
                // æç¤ºæ–‡å­—
                ctx.font = "14px 'Noto Sans TC'";
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                ctx.fillText("æˆ³ç ´æˆ‘ / Pop Me", 0, 25);
                ctx.restore();
            }
        }

        /* --- ç³»çµ±é‚è¼¯ --- */

        function init() {
            resize();
            window.addEventListener('resize', resize);
            
            // Start Bubble
            resetStartBubble();

            // äº‹ä»¶ç›£è½
            canvas.addEventListener('mousedown', handlePointerDown);
            window.addEventListener('mouseup', handlePointerUp);
            canvas.addEventListener('mousemove', handlePointerMove);
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // é˜²æ­¢æ»¾å‹•
                handlePointerDown(e.touches[0]);
            }, {passive: false});
            window.addEventListener('touchend', handlePointerUp);
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                handlePointerMove(e.touches[0]);
            }, {passive: false});

            // éµç›¤æ§åˆ¶
            window.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && !pointer.isDown) {
                    pointer.isDown = true;
                    pointer.downStart = Date.now();
                    // æ¨¡æ“¬æ»‘é¼ åœ¨ä¸­å¿ƒ
                    if (pointer.x === 0 && pointer.y === 0) {
                        pointer.x = width / 2;
                        pointer.y = height / 2;
                    }
                }
            });
            window.addEventListener('keyup', (e) => {
                if (e.code === 'Space') {
                    handlePointerUp();
                }
            });

            // UI ç¶å®š
            setupUI();

            requestAnimationFrame(loop);
        }

        function setupUI() {
            document.getElementById('range-wind').addEventListener('input', (e) => {
                env.wind = parseFloat(e.target.value);
                document.getElementById('val-wind').innerText = env.wind;
            });
            document.getElementById('range-light').addEventListener('input', (e) => {
                env.lightAngle = parseInt(e.target.value);
                document.getElementById('val-light').innerText = env.lightAngle + "Â°";
            });
            document.getElementById('range-life').addEventListener('input', (e) => {
                env.bubbleLife = parseInt(e.target.value);
                let txt = "çŸ­";
                if(env.bubbleLife > 150) txt = "ä¸­";
                if(env.bubbleLife > 350) txt = "é•·";
                document.getElementById('val-life').innerText = txt;
            });
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            if (currentState === STATE.START_SCREEN && startBubble) {
                startBubble.x = width / 2;
                startBubble.y = height / 2;
            }
        }

        function resetStartBubble() {
            startBubble = new StartBubble(width / 2, height / 2);
        }

        // è¼¸å…¥è™•ç†
        function handlePointerDown(e) {
            pointer.x = e.clientX;
            pointer.y = e.clientY;
            pointer.isDown = true;
            pointer.downStart = Date.now();

            if (currentState === STATE.START_SCREEN) {
                // æª¢æŸ¥æ˜¯å¦é»åˆ° Start æ³¡æ³¡
                const dx = pointer.x - startBubble.x;
                const dy = pointer.y - startBubble.y;
                if (Math.sqrt(dx*dx + dy*dy) < startBubble.radius) {
                    startBubble.pop();
                    setTimeout(startGame, 200);
                }
            } else if (currentTool === TOOLS.WAND) {
                // Må‹å¤¾é‚è¼¯ï¼šè¨˜éŒ„èµ·é»
                pointer.startX = pointer.x;
                pointer.startY = pointer.y;
            }
        }

        function handlePointerMove(e) {
            pointer.x = e.clientX;
            pointer.y = e.clientY;
        }

        function handlePointerUp() {
            if (!pointer.isDown) return;
            
            pointer.isDown = false;
            const duration = Date.now() - pointer.downStart;

            if (currentState === STATE.PLAYING) {
                // æ‰‹æ‰‹å·¥å…·ï¼šæ”¾é–‹æ™‚å¦‚æœé‚„æ²’ç™¼å°„ (é›–ç„¶ updateToolHand è‡ªå‹•è™•ç†ï¼Œä½†ä¹Ÿè¨±æœ‰è“„åŠ›æ©Ÿåˆ¶)
                // é€™è£¡ä¸»è¦è™•ç† Må‹å¤¾çš„ç™¼å°„
                if (currentTool === TOOLS.WAND) {
                    fireWandBubble();
                }
            }
        }

        function startGame() {
            currentState = STATE.PLAYING;
            document.body.classList.add('game-active');
            
            // æ›´æ–° UI ç‹€æ…‹
            const btns = document.querySelectorAll('.tool-btn');
            btns.forEach((btn, idx) => {
                if (idx === 0) btn.classList.add('active');
            });
        }

        window.selectTool = function(toolIndex) {
            currentTool = toolIndex;
            // æ›´æ–° UI
            const btns = document.querySelectorAll('.tool-btn');
            btns.forEach((btn, idx) => {
                if (idx === toolIndex) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        // å·¥å…·ç”¢ç”Ÿé‚è¼¯
        function updateTools() {
            if (!pointer.isDown) return;

            if (currentTool === TOOLS.GUN) {
                // é›™æ§ï¼šé »ç‡å¿«ï¼Œä¸€æ¬¡å…©é¡†ï¼Œä½ç½®ç¨å¾®åç§»
                if (Date.now() % 100 < 20) { // ç°¡å–®çš„é »ç‡æ§åˆ¶
                    const offset = 20;
                    spawnBubble(pointer.x - offset, pointer.y, 10 + Math.random() * 5);
                    spawnBubble(pointer.x + offset, pointer.y, 10 + Math.random() * 5);
                }
            } else if (currentTool === TOOLS.HAND) {
                // æ‰‹æ‰‹ï¼šæ…¢é€Ÿï¼Œä¸­å‹æ³¡æ³¡
                if (Date.now() % 500 < 20) {
                    spawnBubble(pointer.x, pointer.y, 30 + Math.random() * 10);
                }
            }
            // WAND åœ¨ update ä¸­åªè² è²¬ç¹ªè£½æ‹‰ä¼¸ç·šï¼Œç™¼å°„åœ¨ mouseup
        }

        function fireWandBubble() {
            // è¨ˆç®—æ‹‰ä¼¸è·é›¢
            const dx = pointer.x - pointer.startX;
            const dy = pointer.y - pointer.startY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            // æ ¹æ“šæ‹‰ä¼¸é•·åº¦æ±ºå®šå¤§å°ï¼Œæœ‰ä¸Šé™
            let radius = Math.min(dist * 0.4, 150); 
            if (radius < 20) radius = 20; // æœ€å°é™åˆ¶

            // æ ¹æ“šæ‹‰ä¼¸æ–¹å‘ç”¢ç”Ÿåå‘é€Ÿåº¦ (å½ˆå¼“æ•ˆæ‡‰)
            const velocityScale = 0.15;
            const vx = -dx * velocityScale + (env.wind * 2); // åŠ ä¸Šé¢¨çš„å½±éŸ¿
            const vy = -dy * velocityScale;

            // ç”¢ç”Ÿå¤§æ³¡æ³¡
            const b = new Bubble(pointer.x, pointer.y, radius, vx, vy);
            // å¤§æ³¡æ³¡æŠ–å‹•æ›´å²å®³
            b.wobbleAmp = 0.4; 
            bubbles.push(b);
        }

        function spawnBubble(x, y, baseRadius) {
            // æ ¹æ“šæ»‘é¼ ç§»å‹•ç”¢ç”Ÿåˆå§‹é€Ÿåº¦
            const vx = (Math.random() - 0.5) * 2 + (env.wind * 0.5);
            const vy = (Math.random() - 0.5) * 2 - 2; // ç¨å¾®å‘ä¸Šå™´
            bubbles.push(new Bubble(x, y, baseRadius, vx, vy));
        }

        // ç¹ªè£½ Må‹å¤¾çš„æ‹‰ä¼¸ç·š
        function drawWandVisuals() {
            if (currentState === STATE.PLAYING && currentTool === TOOLS.WAND && pointer.isDown) {
                ctx.save();
                ctx.beginPath();
                // æ¨¡æ“¬ä¸€å€‹ä¸‰è§’å½¢æˆ–æ¢¯å½¢è†œ
                ctx.moveTo(pointer.startX - 30, pointer.startY);
                ctx.lineTo(pointer.x, pointer.y); // æ»‘é¼ ä½ç½®
                ctx.lineTo(pointer.startX + 30, pointer.startY);
                
                // å¡«å……æ²¹è†œæ„Ÿ
                ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
                ctx.fill();
                
                // é‚Šæ¡†ç·š
                ctx.strokeStyle = "rgba(255, 255, 255, 0.5)";
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ç•«å‡ºå…©å€‹æ§åˆ¶é» (å¤¾å­é ­)
                ctx.fillStyle = "#aaa";
                ctx.beginPath();
                ctx.arc(pointer.startX - 30, pointer.startY, 5, 0, Math.PI*2);
                ctx.arc(pointer.startX + 30, pointer.startY, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.restore();
            }
        }

        /* --- ä¸»è¿´åœˆ --- */
        function loop() {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, width, height);

            if (currentState === STATE.START_SCREEN) {
                if (startBubble) {
                    startBubble.update();
                    startBubble.draw(ctx);
                }
            } else {
                updateTools();
                drawWandVisuals();
            }

            // æ›´æ–°èˆ‡ç¹ªè£½æ³¡æ³¡
            for (let i = bubbles.length - 1; i >= 0; i--) {
                bubbles[i].update();
                bubbles[i].draw(ctx);
                if (bubbles[i].popping) {
                    bubbles.splice(i, 1);
                }
            }

            // æ›´æ–°èˆ‡ç¹ªè£½ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw(ctx);
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }

            requestAnimationFrame(loop);
        }

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>
