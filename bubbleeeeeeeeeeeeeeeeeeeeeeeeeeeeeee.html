<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤¢å¹»æ³¡æ³¡å¯¦é©—å®¤ - éŸ³æ¨‚ç‰ˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            font-family: 'Noto Sans TC', sans-serif;
            user-select: none; -webkit-user-select: none;
        }

        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; cursor: crosshair; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

        /* è¶…å¤§é–‹å ´æ–‡å­— */
        #intro-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 8vw; font-weight: 900; color: rgba(255, 255, 255, 0.1);
            text-transform: uppercase; letter-spacing: 5px; pointer-events: none;
            transition: opacity 1s, transform 1s; z-index: 5;
            text-shadow: 0 0 30px rgba(255,255,255,0.2);
        }
        #intro-text.fade-out { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }

        /* å´é‚Šå·¥å…·æ¬„ */
        .sidebar {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; pointer-events: auto; z-index: 100;
        }

        .sidebar-btn-container { position: relative; }
        .sidebar-btn {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px;
            width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s; color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .sidebar-btn:hover { background: rgba(255, 255, 255, 0.25); transform: scale(1.1); }
        .sidebar-btn.active { background: rgba(100, 200, 255, 0.4); border-color: rgba(100, 200, 255, 0.8); }

        /* å½ˆå‡ºé¢æ¿ */
        .pop-panel {
            position: absolute; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px;
            padding: 10px; pointer-events: auto; display: none; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); z-index: 150;
        }
        .pop-panel.show { display: flex; }
        #panel-gen { right: 85px; top: 100px; }
        
        .sub-tool-btn {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            color: white; border-radius: 8px; cursor: pointer; width: 45px; height: 45px;
            display: flex; justify-content: center; align-items: center; margin: 0 5px;
        }
        .sub-tool-btn.active { background: rgba(100, 200, 255, 0.4); border-color: #64c8ff; }

        /* åº•éƒ¨æ§åˆ¶å°æ¨£å¼ç•¥... (ä¿æŒåŸæ¨£ä»¥ç¯€çœç©ºé–“) */
        .vars-container { display: flex; gap: 20px; color: white; padding: 10px; }
        input[type=range] { width: 100px; }
    </style>
</head>
<body>

    <div id="canvas-container">
        <canvas id="bubbleCanvas"></canvas>
    </div>

    <div id="intro-text">BUBBLE LAB</div>

    <div id="ui-layer">
        <div class="sidebar">
            <div class="sidebar-btn-container">
                <div class="sidebar-btn" id="btn-main-gen" onclick="togglePopPanel('panel-gen')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                </div>
            </div>
            <div class="sidebar-btn-container">
                <div class="sidebar-btn" id="btn-main-needle" onclick="selectMainTool(3)">
                    <svg viewBox="0 0 24 24"><path d="M20 4L4 20" stroke="white" stroke-width="2"/></svg>
                </div>
            </div>
        </div>

        <div class="pop-panel" id="panel-gen">
            <div class="sub-tool-btn" id="btn-sub-gun" onclick="selectSubTool(0)">ğŸ”«</div>
            <div class="sub-tool-btn" id="btn-sub-wand-simple" onclick="selectSubTool(6)">ğŸ§²</div>
        </div>
    </div>

    <script>
        // --- éŸ³æ¨‚èˆ‡éŸ³æ•ˆç®¡ç†ç³»çµ± ---
        const AudioSys = {
            ctx: null,
            bgmOsc: null,
            init() {
                if (this.ctx) return;
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.startBGM();
            },
            startBGM() {
                // å‰µé€ ä¸€å€‹ç°¡å–®çš„å¾ªç’°è¼•å¿«æ—‹å¾‹ (å°èª¿äº”è²éŸ³éš)
                const notes = [261.63, 293.66, 329.63, 392.00, 440.00]; // C4, D4, E4, G4, A4
                let step = 0;
                setInterval(() => {
                    if (currentState !== 1) return; // åƒ…åœ¨éŠæˆ²ä¸­æ’­æ”¾
                    this.playNote(notes[step % notes.length], 0.1, 0.05);
                    step += (Math.random() > 0.8 ? 2 : 1);
                }, 250);
            },
            playNote(freq, dur, vol) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle'; // è¼ƒæŸ”å’Œçš„è²éŸ³
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + dur);
            },
            playPop() {
                if (!this.ctx) return;
                this.playNote(800 + Math.random() * 400, 0.1, 0.1);
            }
        };

        const canvas = document.getElementById('bubbleCanvas');
        const ctx = canvas.getContext('2d');
        const TOOLS = { GUN: 0, WAND_SIMPLE: 6, NEEDLE: 3 };
        let currentState = 0; // 0: Start, 1: Playing
        let currentTool = TOOLS.GUN;
        let width, height;
        let bubbles = [];
        let particles = [];
        let pointer = { x: 0, y: 0, isDown: false, startX: 0, startY: 0 };
        let env = { wind: 2, bubbleLife: 300, bubbleSize: 1 };

        // --- æ³¡æ³¡é¡åˆ¥ ---
        class Bubble {
            constructor(x, y, radius, vx, vy) {
                this.x = x; this.y = y; this.radius = radius;
                this.vx = vx; this.vy = vy;
                this.maxLife = env.bubbleLife + Math.random() * 100;
                this.age = 0; this.popping = false;
            }
            update() {
                this.age++;
                this.x += this.vx; this.y += this.vy;
                this.vy -= 0.02; // æµ®åŠ›
                if (this.age > this.maxLife) this.pop();
            }
            draw() {
                ctx.beginPath();
                const grad = ctx.createRadialGradient(this.x-this.radius*0.3, this.y-this.radius*0.3, this.radius*0.1, this.x, this.y, this.radius);
                grad.addColorStop(0, "rgba(255,255,255,0.4)");
                grad.addColorStop(1, "hsla("+(this.age%360)+", 70%, 70%, 0.3)");
                ctx.fillStyle = grad;
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fill();
                ctx.strokeStyle = "rgba(255,255,255,0.5)";
                ctx.stroke();
            }
            pop() {
                this.popping = true;
                AudioSys.playPop();
                for(let i=0; i<8; i++) particles.push(new Particle(this.x, this.y));
            }
        }

        class Particle {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.vx = (Math.random()-0.5)*5; this.vy = (Math.random()-0.5)*5;
                this.life = 1.0;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
            draw() { ctx.fillStyle = `rgba(200,220,255,${this.life})`; ctx.fillRect(this.x, this.y, 2, 2); }
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function init() {
            resize();
            window.addEventListener('resize', resize);
            canvas.addEventListener('mousedown', handleDown);
            window.addEventListener('mouseup', handleUp);
            canvas.addEventListener('mousemove', e => { pointer.x = e.clientX; pointer.y = e.clientY; });
            loop();
        }

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }

        function handleDown(e) {
            AudioSys.init(); // å•Ÿå‹• AudioContext
            pointer.isDown = true;
            pointer.startX = e.clientX;
            pointer.startY = e.clientY;

            if (currentState === 0) {
                currentState = 1;
                document.getElementById('intro-text').classList.add('fade-out');
            }
        }

        function handleUp() {
            if (!pointer.isDown) return;
            pointer.isDown = false;
            // æ›¿æ›å¾Œçš„ M å‹å¤¾é‚è¼¯ï¼šæ”¾é–‹æ™‚å½ˆå°„
            if (currentTool === TOOLS.WAND_SIMPLE) {
                fireWandBubble();
            }
        }

        // --- å–ä»£å¾Œçš„ M å‹å¤¾ç™¼å°„ç¨‹å¼ç¢¼ ---
        function fireWandBubble() {
            const dx = pointer.x - pointer.startX;
            const dy = pointer.y - pointer.startY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            let radius = Math.min(dist * 0.4, 150); 
            if (radius < 20) radius = 20;

            const velocityScale = 0.15;
            const vx = -dx * velocityScale;
            const vy = -dy * velocityScale;

            bubbles.push(new Bubble(pointer.x, pointer.y, radius, vx, vy));
        }

        function drawWandVisuals() {
            if (currentTool === TOOLS.WAND_SIMPLE && pointer.isDown) {
                ctx.beginPath();
                ctx.moveTo(pointer.startX - 30, pointer.startY);
                ctx.lineTo(pointer.x, pointer.y);
                ctx.lineTo(pointer.startX + 30, pointer.startY);
                ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
                ctx.fill();
                ctx.strokeStyle = "white";
                ctx.stroke();
            }
        }

        function loop() {
            ctx.clearRect(0, 0, width, height);
            
            if (currentState === 1) {
                if (currentTool === TOOLS.GUN && pointer.isDown && Math.random() > 0.8) {
                    bubbles.push(new Bubble(pointer.x, pointer.y, 10 + Math.random()*10, (Math.random()-0.5)*4, (Math.random()-0.5)*4));
                }
                drawWandVisuals();
            }

            bubbles.forEach((b, i) => {
                b.update(); b.draw();
                if (currentTool === TOOLS.NEEDLE && pointer.isDown) {
                    let d = Math.hypot(b.x - pointer.x, b.y - pointer.y);
                    if (d < b.radius) b.pop();
                }
            });
            bubbles = bubbles.filter(b => !b.popping);

            particles.forEach(p => { p.update(); p.draw(); });
            particles = particles.filter(p => p.life > 0);

            requestAnimationFrame(loop);
        }

        function togglePopPanel(id) {
            const p = document.getElementById(id);
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        }

        function selectSubTool(t) {
            currentTool = t;
            document.querySelectorAll('.sub-tool-btn').forEach(b => b.classList.remove('active'));
            if(t === 0) document.getElementById('btn-sub-gun').classList.add('active');
            if(t === 6) document.getElementById('btn-sub-wand-simple').classList.add('active');
        }
        
        function selectMainTool(t) {
            currentTool = t;
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-main-needle').classList.add('active');
        }

        init();
    </script>
</body>
</html>
